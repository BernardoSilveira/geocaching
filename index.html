<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Vysvědčení</title>
        <meta name="description" content="Vysvědčení">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <!-- <link rel="stylesheet" href=""> -->
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>   
        <style>
            .d5 {
                text-align: center;
                width: 40px;
            }

            html * {
            font-family: Book Antiqua;
            }
        </style>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <div id="content-container" style="margin: auto; width: 30%;">
            <h1>Vysvědčení</h1>
            <form>
                <div class="form-group">
                    <label for="geo-input">Paste your input here:</label>
                    <textarea name="Input" id="geo-input" class="form-control" cols="30" rows="10"></textarea>
                </div>
                <button type="button" id="geo-submit" class="btn btn-primary">Submit</button>
            </form>
            <br>
            <!-- <h2 id="geo-output">Output:</h2> -->
            <div id="output-container" style="visibility: hidden;">
                <div style="margin: auto; width: 75%;">
                    <h2 style="font-size: 80px;">Vysvědčení</h2>
                    <div style="font-size: 20px; margin: auto; width: 75%;">
                        <span>Jméno: </span><span id="nickname"></span>
                        <span style="margin-left: 20px;">Obor: Geochaning</span>
                        <p>Specializace (kód): GC9M732</p>
                    </div>
                </div>

                <table class="table table-bordered">
                    <thead>
                        <th scope="col">Předmět</th>
                        <th scope="col">Známka</th>
                        <th scope="col">Odůvodnění</th>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">Různorodost</th>
                            <td class="d5">D5</td>
                            <td id="row0"></td>
                        </tr>
                        <tr>
                            <th scope="row">Typologie</th>
                            <td class="d5">D5</td>
                            <td id="row1"></td>
                        </tr>
                        <tr>
                            <th scope="row">Vlastiznalství</th>
                            <td class="d5">D5</td>
                            <td id="row2"></td>
                        </tr>
                        <tr>
                            <th scope="row">Světoběžnictví</th>
                            <td class="d5">D5</td>
                            <td id="row3"></td>
                        </tr>
                        <tr>
                            <th scope="row">Všestrannost</th>
                            <td class="d5">D5</td>
                            <td id="row4"></td>
                        </tr>
                        <tr>
                            <th scope="row">Lezectví</th>
                            <td class="d5">T5</td>
                            <td id="row5">vylezl na strom (pokud je zapsán v logbooku)</td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin: auto; width: 60%;"><span >Vydali VeselíMimoni, v Praze, dne </span><span id="date"></span></div>
            </div>
        </div>
        
        <!-- <script src="script.js" async defer></script> -->
        <script>
            let input_str = ""
            let month_names_array =["Jan","Feb","Mar","Apr",
                            "May","Jun","Jul","Aug",
                            "Sep", "Oct","Nov","Dec"];

            document.getElementById("geo-submit").onclick = function () {
                let container = document.getElementById("output-container");
                container.style.visibility = "visible";

                input_str = document.getElementById("geo-input").value;

                const row_text_array = [
                    ["našel alespoň ",  " keší pro ", " druhů keší"],
                    ["našel alespoň ", " keší ve všech velikostech"],
                    ["našel alespoň ", " druhů keší v každém kraji"],
                    ["našel alespoň 5 druhů keší v ", " státech"],
                    ["poskládal ", " krát matrix"]
                ];

                if (input_str !== "") {
                    const date = new Date();

                    const month_index = date.getMonth();
                    const month_name = month_names_array[month_index];
                    const year = date.getFullYear();
                    const day = date.getDate();

                    let phase_count = 0;
                    let cz_count = 0;
                    let country_count = 0;
                    let lowest_find_typ_1 = 0;
                    let lowest_find_ruz_1 = 0;
                    let five_five_count_ruz_2 = 0;
                    let matrix_count = 0;
                                                           
                    let get_user_value_regex = /^User has ([0-9]+)/;
                    let get_country_types_value_regex = /([0-9]+) countries/;
                    let get_cz_caches_value_regex = /caches \(([0-9]+)\)/
                    let get_matrix_value_regex = /ok:([0-9]+)/;
                    let get_nickname_regex = /^\[([\w]+)/;

                    let input_by_lines = input_str.split("\n");

                    let nickname_match = get_nickname_regex.exec(input_by_lines[0]);
                    const nickname = nickname_match[1];

                    document.getElementById("date").innerHTML = day + "." + month_name + "." + year;

                    document.getElementById("nickname").innerHTML = nickname;

                    input_by_lines.forEach((value, index) => {

                        if (value === "}") {
                            phase_count++;
                            // console.log(phase_count);

                        } else if (phase_count === 0) {
                            let value_match = get_user_value_regex.exec(value);
                            let int_value = 0;
                            // console.log(value_match);

                            if (value_match !== null) {
                                int_value = parseInt(value_match[1]);
                                // console.log(int_value);
                                if (int_value >= 55) {
                                    five_five_count_ruz_2++;
                                    if (lowest_find_ruz_1 === 0 || (int_value < lowest_find_ruz_1) ) lowest_find_ruz_1 = int_value;
                                }
                                // size_count += int_value;
                            }
                            
                        } else if (phase_count === 1) {
                            let value_match = get_user_value_regex.exec(value);
                            let int_value = 0;
                            // console.log(value_match);

                            if (value_match !== null) {
                                int_value = parseInt(value_match[1]);
                                if (int_value >= 55) {
                                    if (lowest_find_typ_1 === 0 || (int_value < lowest_find_typ_1) ) lowest_find_typ_1 = int_value;
                                }
                                // if (lowest_find_ruz_1 === 0 || (int_value < lowest_find_ruz_1) ) lowest_find_ruz_1 = int_value;

                                // if (int_value >= 55) test_count += int_value;
                                // console.log(five_five_count_typ_1);
                                // console.log(test_count);
                            }

                        } else if (phase_count === 2) {
                            let value_match = get_cz_caches_value_regex.exec(value);

                            if (value_match !== null) {
                                cz_count = parseInt(value_match[1]);
                                phase_count++;
                            }
                        } else if (phase_count === 3) {
                            let value_match = get_country_types_value_regex.exec(value);

                            if (value_match !== null) {
                                country_count = parseInt(value_match[1]);
                                phase_count++;
                            }
                        } else {
                            let value_match = get_matrix_value_regex.exec(value);

                            if (value_match !== null) {
                                matrix_count = parseInt(value_match[1]);
                                phase_count++;
                            }
                        }
                    });
                    // console.log(cz_count);
                    // console.log(country_count);
                    // console.log(matrix_count);
                    // positions_array.forEach(iterate_positions);
                    // function iterate_positions(position, index, positions_array) {
                    //     // console.log(position + ": " + index);
                    //     const row_text = row_text_array[index];
                    //     const row_data = input_array[position];
                    //     const row_data_int = parseInt(row_data);
                    //     const row_id = "row" + index.toString();

                    //     if (row_data_int < 5) {
                    //         let full_row = document.getElementById(row_id).parentElement;
                    //         full_row.classList.add("bg-danger");
                    //     }

                    //     document.getElementById(row_id).innerHTML = row_text[0] + row_data + row_text[1];
                    // }

                    document.getElementById("row0").innerHTML = row_text_array[0][0] 
                                                                + lowest_find_ruz_1 
                                                                + row_text_array[0][1] 
                                                                + five_five_count_ruz_2 
                                                                + row_text_array[0][2];
                    
                    document.getElementById("row1").innerHTML = row_text_array[1][0] + lowest_find_typ_1 + row_text_array[1][1];
                    document.getElementById("row2").innerHTML = row_text_array[2][0] + cz_count + row_text_array[2][1]; 
                    document.getElementById("row3").innerHTML = row_text_array[3][0] + country_count + row_text_array[3][1]; 
                    document.getElementById("row4").innerHTML = row_text_array[4][0] + matrix_count + row_text_array[4][1];

                    document.getElementById("row5").innerHTML = "vylezl na strom (pokud je zapsán v logbooku)";

                    // output_test = JSON.stringify(input_array);
                    // console.log(output_test);
                    // document.getElementById("geo-output").innerHTML = input_str;
                    // html2canvas(container, {
                    //     onrendered: function (canvas) {
                    //         let a = document.createElement('a');
                    //         a.href = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                    //         // a.href = URL.createObjectURL(canvas);
                    //         a.download = "vysvedceni.png";

                    //         document.body.appendChild(a)
                    //         a.click();
                    //         document.body.removeChild(a);
                    //     }
                    // });
                    html2canvas(container).then(function (canvas) {
                            saveAs(canvas.toDataURL(), "vysvedceni.png");
                    });

                    function saveAs(uri, filename) {

                        var link = document.createElement('a');

                        if (typeof link.download === 'string') {

                            link.href = uri;
                            link.download = filename;

                            //Firefox requires the link to be in the body
                            document.body.appendChild(link);

                            //simulate click
                            link.click();

                            //remove the link when done
                            document.body.removeChild(link);

                        } else {

                            window.open(uri);

                        };
                    };
                };
            };
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    </body>
</html>